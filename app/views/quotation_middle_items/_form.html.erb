<%= simple_form_for @quotation_middle_item, :html => { :class => 'well form-horizontal' } do |f| %>
  <%= f.input :quotation_middle_item_name, input_html:{:tabindex=> "0"} %>
  <%= f.input :quotation_middle_item_short_name, input_html:{:tabindex=> "1"} %>
  <%= f.input :quotation_middle_specification, input_html:{:tabindex=>"2"} %>
  <%= f.label :"単位" , {:class => "my-custom-class-l"} %></br>
  <%= f.collection_select :quotation_unit_id, QuotationUnit.all, :id, :quotation_unit_name, {:prompt => 'どれか一つを選択して下さい', :selected => @quotation_middle_item.quotation_unit_id || 2 } , {id:'quotation_unit_id', :class => "searchableQuotationUnit",  :tabindex=>"3", style: 'width:220px' } %></br>
  <%= f.input :quotation_unit_price, input_html:{id:"quotation_unit_price", :tabindex=>"4" }   %>
  <%= f.input :execution_unit_price, input_html:{id:"execution_unit_price", :tabindex=>"5" }  %>
  <%= f.label :使用材料 , {:class => "my-custom-class-l"} %></br>
  <%= f.collection_select :material_id, MaterialMaster.all, :id, :material_code, {:selected => @quotation_middle_item.material_id || 1 } , {id:"material_id", :tabindex=>"6", class: "searchableItem" , style: 'width:220px'} %>
  <%= f.input :quotation_material_name, input_html:{id:"quotation_material_name", :tabindex=>"7" }  %>
  <%= f.input :material_unit_price, input_html:{id:"material_unit_price", :tabindex=>"8", :onchange => "calcAccessory(this.form)"} %>
  <%= f.input :labor_unit_price, input_html:{id:"labor_unit_price", :tabindex=>"9", :onchange => "calcLaborCost(this.form)"}  %>
  <%= f.input :labor_productivity_unit, input_html:{id:"labor_productivity_unit", :tabindex=>"10", :onchange => "calcLaborCost(this.form)"}  %>
  <%= f.input :material_quantity, input_html:{id:"material_quantity", :tabindex=>"11", :onchange => "calcAccessory(this.form)"} %>
  <%= f.input :accessory_cost, input_html:{id:"accessory_cost", :tabindex=>"12" }  %>
  <%= f.input :material_cost_total, input_html:{id:"material_cost_total", :tabindex=>"13" } %>
  <%= f.input :labor_cost_total, input_html:{id:"labor_cost_total", :tabindex=>"14" } %>
  <%= f.input :other_cost, input_html:{id:"other_cost", :tabindex=>"15" } %>
  
  <!--<%= f.button :submit, :class => 'btn-primary' %>-->
  <input type="button" onclick="submit();" class = 'btn btn-primary' value="登録する" />
  <%= link_to t('.cancel', :default => t("helpers.links.cancel")),
                quotation_middle_items_path, :class => 'btn btn-default' %>
<% end %>

<script type="text/javascript">
  $(document).on('ready page:load', function(){
     //検索可能なリストボックス(注文Noの場合)
     $(".searchableQuotationUnit").select2({ theme: "bootstrap" });
	 //select2をenterキー押下した場合(リストが閉じられた時)のタブ移動。イマイチだが・・
	 $( ".searchableQuotationUnit" ).on("select2:close", function (e) {
		$('[tabindex=4]').focus();
	 });
	 
	 
     //検索可能なリストボックス(品名の場合)
     $(".searchableItem").select2({ theme: "bootstrap" });
     $( ".searchableItem" ).change(function(e) {
      　  setItemNameAndPrice();
     });
	 //select2をenterキー押下した場合(リストが閉じられた時)のタブ移動。
	 $( ".searchableItem" ).on("select2:close", function (e) {
		$('[tabindex=7]').focus();
	 });
	 
   });
  
  //(ajax)項目・単価のセット
  function setItemNameAndPrice()
  {  
    obj = document.getElementById("material_id");
     material_id = parseInt(obj.value);
     $.get("<%= quotation_middle_itemz_quotation_material_name_select_path %>",
       {id: material_id },
        function(data){
          obj = document.getElementById("quotation_material_name").textContent;
          document.getElementById("quotation_material_name").value = obj;
		  }
      );
     //単価
      $.get("<%= quotation_middle_itemz_material_unit_price_select_path %>",
       {id: material_id },
        function(data){
          obj = document.getElementById("material_unit_price").textContent;
          document.getElementById("material_unit_price").value = obj;
		  }
      );
   };  

  //金額計算(付属品等)
  function calcAccessory(f)
  {
    //付属品の計算 
    var num = (f.material_unit_price.value * f.material_quantity.value) * 0.3 ;
    //小数点以下を四捨五入
    f.accessory_cost.value = Math.round(num);
  
    //材料費計の計算
    var num = (f.material_unit_price.value * f.material_quantity.value) + parseInt(f.accessory_cost.value); 
    f.material_cost_total.value = num;
   
    if (f.labor_cost_total.value > 0){
       calcOtherCost(f);
    }   
  }
  
  //金額計算(労務費用計)
  function calcLaborCost(f)
  {
    var num = f.labor_unit_price.value * f.labor_productivity_unit.value;
    //小数点以下を四捨五入
    f.labor_cost_total.value = Math.round(num);
    
    if (f.material_cost_total.value > 0){
       calcOtherCost(f);
    }  
  }
  
  //金額計算(その他計)
  function calcOtherCost(f)
  {
    var num = (parseInt(f.material_cost_total.value) + parseInt(f.labor_cost_total.value)) * 0.12 ;
    //小数点以下を四捨五入
    f.other_cost.value = Math.round(num);
    if (f.other_cost.value > 0){
       calcUnitPrice(f);
    }  
  } 
  //金額計算(実行単価)
  function calcUnitPrice(f)
  {
    var num = parseInt(f.material_cost_total.value) + parseInt(f.labor_cost_total.value) + parseInt(f.other_cost.value) ;
    //f.quotation_unit_price.value = num;
    f.execution_unit_price.value = num;
  } 
  
</script>
