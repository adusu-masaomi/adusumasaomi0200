!function(e){var n=0,t=function(){return(new Date).getTime()+n++},a=function(e){return"["+e+"]$1"},o=function(e){return"_"+e+"_$1"},i=function(n,t,a){return n?"function"==typeof n?(t&&console.warn("association-insertion-traversal is ignored, because association-insertion-node is given as a function."),n(a)):"string"==typeof n?t?a[t](n):"this"==n?a:e(n):void 0:a.parent()};e(document).on("click",".add_fields",function(n){n.preventDefault();var s=e(this),r=s.data("association"),c=s.data("associations"),d=s.data("association-insertion-template"),l=s.data("association-insertion-method")||s.data("association-insertion-position")||"after",u=s.data("association-insertion-node"),f=s.data("association-insertion-traversal"),p=parseInt(s.data("count"),10),g=new RegExp("\\[new_"+r+"\\](.*?\\s)","g"),v=new RegExp("_new_"+r+"_(\\w*)","g"),m=t(),_=d.replace(g,a(m)),h=[];for(_==d&&(g=new RegExp("\\[new_"+c+"\\](.*?\\s)","g"),v=new RegExp("_new_"+c+"_(\\w*)","g"),_=d.replace(g,a(m))),_=_.replace(v,o(m)),h=[_],p=isNaN(p)?1:Math.max(p,1),p-=1;p;)m=t(),_=d.replace(g,a(m)),_=_.replace(v,o(m)),h.push(_),p-=1;var w=i(u,f,s);w&&0!=w.length||console.warn("Couldn't find the element to insert the template. Make sure your `data-association-insertion-*` on `link_to_add_association` is correct."),e.each(h,function(n,t){var a=e(t);w.trigger("cocoon:before-insert",[a]);w[l](a);w.trigger("cocoon:after-insert",[a])})}),e(document).on("click",".remove_fields.dynamic, .remove_fields.existing",function(n){var t=e(this),a=t.data("wrapper-class")||"nested-fields",o=t.closest("."+a),i=o.parent();n.preventDefault(),i.trigger("cocoon:before-remove",[o]);var s=i.data("remove-timeout")||0;setTimeout(function(){t.hasClass("dynamic")?o.remove():(t.prev("input[type=hidden]").val("1"),o.hide()),i.trigger("cocoon:after-remove",[o])},s)}),e(document).on("ready page:load",function(){e(".remove_fields.existing.destroyed").each(function(){var n=e(this),t=n.data("wrapper-class")||"nested-fields";n.closest("."+t).hide()})})}(jQuery);